<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES6模块体系及DDN开发规范 | Node.js区块链开发2</title>
    <meta name="description" content="《Node.js区块链开发2》">
    
    
    <link rel="preload" href="/nodejs-blockchain/assets/css/0.styles.b71a1a9b.css" as="style"><link rel="preload" href="/nodejs-blockchain/assets/js/app.9b1d5e7c.js" as="script"><link rel="preload" href="/nodejs-blockchain/assets/js/2.5839780c.js" as="script"><link rel="preload" href="/nodejs-blockchain/assets/js/10.a5621495.js" as="script"><link rel="prefetch" href="/nodejs-blockchain/assets/js/11.94225b2c.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/12.6ec546c9.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/13.01613c6f.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/14.68d5f54c.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/15.dcf3b3c3.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/16.3a5845a4.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/3.bf340dd4.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/4.4304cacd.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/5.647aa7a0.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/6.e03a38cc.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/7.60670af6.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/8.bdfb6020.js"><link rel="prefetch" href="/nodejs-blockchain/assets/js/9.7a4ee88b.js">
    <link rel="stylesheet" href="/nodejs-blockchain/assets/css/0.styles.b71a1a9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nodejs-blockchain/" class="home-link router-link-active"><!----> <span class="site-name">Node.js区块链开发2</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nodejs-blockchain/" class="nav-link">首页</a></div><div class="nav-item"><a href="/nodejs-blockchain/chapter/" class="nav-link router-link-active">目录</a></div> <a href="https://github.com/falost/nodejs-blockchain/" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nodejs-blockchain/" class="nav-link">首页</a></div><div class="nav-item"><a href="/nodejs-blockchain/chapter/" class="nav-link router-link-active">目录</a></div> <a href="https://github.com/falost/nodejs-blockchain/" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/nodejs-blockchain/chapter/00/01-前言.html" class="sidebar-link">序章 写在前面</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第1章 DDN区块链基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nodejs-blockchain/chapter/01/01-运行起来.html" class="sidebar-link">第1节 运行起来</a></li><li><a href="/nodejs-blockchain/chapter/01/02-DDN区块链加密库的选择.html" class="sidebar-link">第2节 DDN区块链加密库的选择</a></li><li><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html" class="active sidebar-link">第3节 DDN区块链模块规范解读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#关于-javascript-的模块体系" class="sidebar-link">关于 JavaScript 的模块体系</a></li><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#es6-模块特点" class="sidebar-link">ES6 模块特点</a></li><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#node-js-使用-es6-语法" class="sidebar-link">Node.js 使用 ES6 语法</a></li><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#ddn区块链模块研发规范" class="sidebar-link">DDN区块链模块研发规范</a></li><li class="sidebar-sub-header"><a href="/nodejs-blockchain/chapter/01/03-DDN区块链模块规范解读.html#参考" class="sidebar-link">参考</a></li></ul></li></ul></section></li><li><a href="/nodejs-blockchain/chapter/02/01-planning.html" class="sidebar-link">第2章 开发实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es6模块体系及ddn开发规范"><a href="#es6模块体系及ddn开发规范" class="header-anchor">#</a> ES6模块体系及DDN开发规范</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>得益于 ES6 和 TS的模块体系，DDN区块链可以快速拆解和迭代。没有这些模块化的基础，我们后面所有的工作都会受阻，可插拔、可视化、可配置等功能就成了一句空话，面向不同企业给予“多链并行，跨链互通”也就非常困难。</p> <p>按照敏捷开发的思路，DDN区块链整体上同样基于“默认优于配置”，在底层开发的代码层面就规定了一些默认的约束和规范。本章咱们就简单的介绍DDN区块链开发中用到的关于模块的组织和实践，方便大家在使用DDN进行深度开发的过程中可以更加便捷。</p> <h2 id="关于-javascript-的模块体系"><a href="#关于-javascript-的模块体系" class="header-anchor">#</a> 关于 JavaScript 的模块体系</h2> <p>JavaScript 最早用在浏览器上，而且很长一段时间里，没有自己的模块（module）体系，无法从小文件开始拆分并拼装成一个大程序，所谓的程序员大牛根本不认为它就是编程语言。与其形成鲜明对比的，就连 CSS 都有<code>@import</code>，更别说C/C++、Java、ruby、Python等语言了。</p> <p>当然，今天这种情形得到改观，特别是在 ES6 出现之后，在语言层面上，实现了模块功能，而且相当简单，必将取代 CommonJS 和 AMD 规范，成为统一浏览器和服务器通用的模块解决方案。但是，在现阶段，还会有些小小的麻烦，核心就在于 ES6 的模块规范与 CommonJS 和 AMD 模块体系差别上。所以，只要搞明白这一点，使用起来就如虎添翼，简单明了了。</p> <h2 id="es6-模块特点"><a href="#es6-模块特点" class="header-anchor">#</a> ES6 模块特点</h2> <p>作为脚本语言，CommonJS 和 AMD 模块体系，只能在运行时确定模块的依赖关系，这个应该是理所当然的事情。而 ES6 模块的设计却是走了静态化的路线，与那些编译类的语言有些类似，在编译时就能确定模块关系，以及输入和输出的变量，这就为 Javascript 带来了很多可能。比如进一步拓宽 JavaScript 的语法，引入宏（macro）和类型检验（type system）这些只能靠静态分析实现的功能。</p> <p>另一个方面是，ES6 模块自动采用严格模式，不管你有没有在模块头部加上<code>&quot;use strict&quot;;</code>，默认限制如下：</p> <ul><li>变量必须声明后再使用</li> <li>函数的参数不能有同名属性，否则报错</li> <li>不能使用<code>with</code>语句</li> <li>不能对只读属性赋值，否则报错</li> <li>不能使用前缀 0 表示八进制数，否则报错</li> <li>不能删除不可删除的属性，否则报错</li> <li>不能删除变量<code>delete prop</code>，会报错，只能删除属性<code>delete global[prop]</code></li> <li><code>eval</code>不会在它的外层作用域引入变量</li> <li><code>eval</code>和<code>arguments</code>不能被重新赋值</li> <li><code>arguments</code>不会自动反映函数参数的变化</li> <li>不能使用<code>arguments.callee</code></li> <li>不能使用<code>arguments.caller</code></li> <li>禁止<code>this</code>指向全局对象</li> <li>不能使用<code>fn.caller</code>和<code>fn.arguments</code>获取函数调用的堆栈</li> <li>增加了保留字（比如<code>protected</code>、<code>static</code>和<code>interface</code>）</li></ul> <p>其中，尤其需要注意<code>this</code>的限制。ES6 模块之中，顶层的<code>this</code>指向<code>undefined</code>，即不应该在顶层代码使用<code>this</code>。</p> <h2 id="node-js-使用-es6-语法"><a href="#node-js-使用-es6-语法" class="header-anchor">#</a> Node.js 使用 ES6 语法</h2> <p>DDN区块链基于Node.js平台，而 Node.js 遵从 CommonJS，对 ES6 模块的处理比较麻烦，因为它与 ES6 模块格式是不兼容的。目前，Node.js 解决方案是，将两者分开，ES6 模块和 CommonJS 采用各自的加载方案。</p> <p>默认情况下，Node.js 要求 ES6 模块采用.mjs后缀文件名，或者在 <code>package.json</code> 里配置字段 <code>type</code> 为 <code>module</code>。也就是说，只要脚本文件里面使用import或者export命令，那么就必须采用.mjs后缀名。require命令不能加载.mjs文件，会报错，只有import命令才可以加载.mjs文件。反过来，.mjs文件里面也不能使用require命令，必须使用import。</p> <p>目前，这项功能还在试验阶段。安装 Node v8.5.0 或以上版本，要用--experimental-modules参数才能打开该功能。</p> <div class="language- extra-class"><pre class="language-text"><code>$ node --experimental-modules my-app.mjs
</code></pre></div><p>在实际的开发过程中，我们采取的手段有两个。一是直接使用上面 Node.js 对 ES6 的规范，二是通过 Babel 等第三方工具，将 ES6 规范的代码编译（配置工具即可）成 对应格式 的代码来使用。DDN区块链采取的是后者，因为毕竟各种配套的工具比较齐备，不必操心其中的不兼容性等潜在问题。</p> <h2 id="ddn区块链模块研发规范"><a href="#ddn区块链模块研发规范" class="header-anchor">#</a> DDN区块链模块研发规范</h2> <p>DDN区块链全部使用 ES6 的模块规则，并在此基础上，规定如下用法：</p> <ul><li>模块名字与文件名字保持一致，比如：import Address from './address';</li> <li>模块内部导出接口命令，只能使用一个<code>export { }</code>的命令形式，其他模块导入使用<code>import { } from</code>的形式导入，也就是说模块的变量名称可能是NPM包内部唯一的；</li> <li>使用NPM包的变量与包名字保持一致，比如：import Dapp from <code>@ddn/dapp</code>;</li> <li>NPM包导出命令，只能使用<code>export default</code>命令。</li></ul> <p>下面，详细说明其中要点。</p> <p>ES6 模块功能主要由两个命令构成：<code>export</code>和<code>import</code>。<code>export</code>命令用于规定模块的对外接口，<code>import</code>命令用于输入其他模块提供的功能。</p> <h3 id="_1-集中输出"><a href="#_1-集中输出" class="header-anchor">#</a> 1. 集中输出</h3> <p>一个模块就是一个独立的文件，该文件内部的所有变量、方法、类等，我们这里统一称为变量，外部是无法获取的。如果你希望外部能够读取他们，就必须使用<code>export</code>关键字输出，即提供接口（不是常量，而是变量），确保与模块内部的变量建立一一对应关系。ES6 允许使用多个<code>export</code>逐个输出，且可以出现在模块的任何位置，但是那样的体验非常不直观，我们约定：</p> <p>模块的导出：</p> <ul><li>一个模块只能有一个<code>export</code>；</li> <li><code>export</code>只能放在文件最末尾，并确保处在作用域的最顶层（比如：不能放在<code>if</code>语句里，否则报错，这是因为处于条件代码块之中，就没法做静态优化了，违背了 ES6 模块的设计初衷）；</li></ul> <p>NPM包的导出：</p> <ul><li>用<code>export default</code>指定默认输出，而不是使用单独的<code>export</code>命令，直接输出所要加载的变量名或函数名，这样无需了解模块细节，借助IDE代码补全，快速开发；</li> <li>代码中使用模块中的变量，尽量携带导入的模块名字，避免名字冲突，尽量不要使用 <code>{ Address } = Asset</code> 过渡；</li></ul> <p>格式如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// @ddn/utils/src/index.js</span>
<span class="token keyword">import</span> AssetTypes <span class="token keyword">from</span> <span class="token string">'./asset-types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RuntimeState <span class="token keyword">from</span> <span class="token string">'./runtime-states'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Address <span class="token keyword">from</span> <span class="token string">'./address'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Amount <span class="token keyword">from</span> <span class="token string">'./amount'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> LimitCache <span class="token keyword">from</span> <span class="token string">'./limit-cache'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Utils <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Bignum <span class="token keyword">from</span> <span class="token string">'./bignumber'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    AssetTypes<span class="token punctuation">,</span>
    RuntimeState<span class="token punctuation">,</span>
    Address<span class="token punctuation">,</span>
    Amount<span class="token punctuation">,</span>
    LimitCache<span class="token punctuation">,</span>
    Utils<span class="token punctuation">,</span>
    Bignum
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码在<code>export default</code>命令后面，使用大括号指定所要输出的一组变量。这样做就可以在脚本尾部，一眼看清楚输出了哪些变量。通常情况下，<code>export</code>输出的变量就是本来的名字，如果想修改成别的名字，使用<code>as</code>关键字重命名即可，所以<code>export default</code>命令等同于<code>* as default</code>。</p> <p><code>export default</code>命令用于指定模块的默认输出，本质上就是输出一个叫做<code>default</code>的变量或方法，然后<code>import</code>的时候，系统允许你为它取任意名字。显然，一个模块只能有一个默认输出，因此<code>export default</code>命令只能使用一次。所以，import命令后面不用直接加大括号。</p> <p>另外，<code>export</code>语句输出的接口，与其对应的值是动态绑定关系，即通过该接口，可以取到模块内部实时的值。这与 CommonJS 规范完全不同。CommonJS 模块输出的是值的缓存，不存在动态更新。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> foo <span class="token operator">=</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出变量`foo`，值为`bar`，500 毫秒之后变成`baz`</span>
</code></pre></div><p>下面比较一下默认输出和正常输出。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 第一组</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">crc32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 输出</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> crc32 <span class="token keyword">from</span> <span class="token string">'crc32'</span><span class="token punctuation">;</span> <span class="token comment">// 输入</span>

<span class="token comment">// 第二组</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">crc32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 输出</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>crc32<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'crc32'</span><span class="token punctuation">;</span> <span class="token comment">// 输入</span>
</code></pre></div><p>上面代码的两组写法，第一组是使用<code>export default</code>时，对应的<code>import</code>语句不需要使用大括号；第二组是不使用<code>export default</code>时，对应的<code>import</code>语句需要使用大括号。</p> <h3 id="_2-集中输入"><a href="#_2-集中输入" class="header-anchor">#</a> 2. 集中输入</h3> <p>使用<code>export</code>命令定义了模块的对外接口以后，其他 JS 文件就可以通过<code>import</code>命令加载这个模块。</p> <ul><li><p>在NPM包内的一个模块导入，</p></li> <li><p>NPM包的导入，代码如下：</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>// 不正确
import { Address } from '@ddn/utils'
console.log(Address); // 输出 undefined

// 正确
import Utils from '@ddn/utils'
console.log(Utils.Address);

或者
// 正确
const { Address } = Utils；
console.log(Address);
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> year <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./profile.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  element<span class="token punctuation">.</span>textContent <span class="token operator">=</span> firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> lastName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>import</code>命令输入的变量都是只读的，因为它的本质是输入接口。也就是说，不允许在加载模块的脚本里面，改写接口。也就是说，凡是输入的变量，即便能改写，也都要当作完全只读，不要轻易改变它的属性。</p></li> <li><p><code>import</code>后面的<code>from</code>指定模块文件的位置，可以是相对路径，也可以是绝对路径，<code>.js</code>后缀可以省略。如果只是模块名，不带有路径，那么必须有配置文件，告诉 JavaScript 引擎该模块的位置。</p></li> <li><p><code>import</code>命令是编译阶段执行的，在代码运行之前。因此，<code>import</code>命令具有提升效果，会提升到整个模块的头部，首先执行。所以也不能使用表达式和变量，这些只有在运行时才能得到结果的语法结构。</p></li> <li><p><code>import</code>语句是 Singleton 模式。如果多次重复执行同一句<code>import</code>语句，那么只会执行一次，而不会执行多次。</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>目前阶段，通过 Babel 转码，CommonJS 模块的<code>require</code>命令和 ES6 模块的<code>import</code>命令，可以写在同一个模块里面，但是不要这样做。因为<code>import</code>在静态解析阶段执行，所以它是一个模块之中最早执行的。下面的代码可能不会得到预期结果。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'core-js/modules/es6.symbol'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'core-js/modules/es6.promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'React'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>模块整体加载所在的那个对象，应该是可以静态分析的，所以不允许运行时改变。下面的写法都是不允许的。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> circle <span class="token keyword">from</span> <span class="token string">'./circle'</span><span class="token punctuation">;</span>

<span class="token comment">// 下面两行都是不允许的</span>
circle<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
circle<span class="token punctuation">.</span><span class="token function-variable function">area</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-接口转发"><a href="#_3-接口转发" class="header-anchor">#</a> 3. 接口转发</h3> <p>在一个模块之中，先输入后输出<strong>同一个模块</strong>，<code>import</code>语句可以与<code>export</code>语句写在一起，这就是所谓的接口转发。转发出去的变量在当前模块是无法使用的（因为直接导出了）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>

<span class="token comment">// 可以简单理解为</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 当前模块不能直接使用`foo`和`bar`</span>
</code></pre></div><p>接口转发的好处：</p> <ul><li>主要是模块的接口改名和整体输出。对于第三方模块，具名接口改默认接口，更加适用。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 接口改名</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> foo <span class="token keyword">as</span> myFoo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span>

<span class="token comment">// 整体输出</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'my_module'</span><span class="token punctuation">;</span> <span class="token comment">// 与 默认接口有区别，这里忽略`my_module`模块的`default`方法，将其他各种变量都原封不动的输出，类似继承</span>
</code></pre></div><p>默认接口的写法如下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
</code></pre></div><p>具名接口改为默认接口的写法如下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> es6 <span class="token keyword">as</span> <span class="token keyword">default</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./someModule'</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> es6 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./someModule'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> es6<span class="token punctuation">;</span>
</code></pre></div><p>同样地，默认接口也可以改名为具名接口。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> es6 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./someModule'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>实现模块的继承</li></ul> <p>假设有一个<code>circleplus</code>模块，继承了<code>circle</code>模块。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// circleplus.js</span>

<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'circle'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token number">2.71828182846</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中的<code>export *</code>，表示再输出<code>circle</code>模块的所有属性和方法。然后，又输出了自定义的<code>e</code>变量和默认方法。也可以将<code>circle</code>的属性或方法，改名后再输出。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// circleplus.js</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> area <span class="token keyword">as</span> circleArea <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'circle'</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码表示，只输出<code>circle</code>模块的<code>area</code>方法，且将其改名为<code>circleArea</code>。</p> <h3 id="_4-常量处理"><a href="#_4-常量处理" class="header-anchor">#</a> 4. 常量处理</h3> <p><code>const</code>声明的常量只在当前代码块有效。如果想设置跨模块的常量（即跨多个文件），或者说一个值要被多个模块甚至多个NPM包共享，DDN区块链采用下面的写法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// constants.js 模块</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">// test1.js 模块</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> constants <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token comment">// test2.js 模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><p>如果要使用的常量非常多，可以建一个专门的<code>constants</code>目录，将各种常量写在不同的文件里面，保存在该目录下。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// constants/db.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'http://my.couchdbserver.local:5984'</span><span class="token punctuation">,</span>
  admin_username<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
  admin_password<span class="token operator">:</span> <span class="token string">'admin password'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// constants/user.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'staff'</span><span class="token punctuation">,</span> <span class="token string">'ceo'</span><span class="token punctuation">,</span> <span class="token string">'chief'</span><span class="token punctuation">,</span> <span class="token string">'moderator'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>然后，将这些文件输出的常量，合并在<code>index.js</code>里面。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// constants/index.js</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>db<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./db'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>users<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./users'</span><span class="token punctuation">;</span>
</code></pre></div><p>使用的时候，直接加载<code>index.js</code>就可以了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// script.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>db<span class="token punctuation">,</span> users<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants/index'</span><span class="token punctuation">;</span>◊
</code></pre></div><h3 id="_5-动态加载"><a href="#_5-动态加载" class="header-anchor">#</a> 5. 动态加载</h3> <p>为了根据运行时需要加载不同模块，或者根据不同条件或路径加载不同模块，就需要用到动态加载。鉴于DDN区块链的灵活架构，必然大量用到这一功能，ES5阶段使用的是<code>require</code>函数，但是上面说了，不建议与<code>import</code>混用，我们将慢慢规范统一处理成这里的方法逻辑。</p> <p><code>import()</code>方法负责动态加载，可以取代<code>require</code>的动态加载功能。<code>import</code>命令能够接受什么参数，<code>import()</code>函数就能接受什么参数，两者区别主要是后者为动态加载。<code>import()</code>类似于 Node 的<code>require</code>方法，区别主要是前者是异步加载，后者是同步加载。</p> <p><code>import()</code>返回一个 Promise 对象。比如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> main <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./section-modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>someVariable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span><span class="token function">loadPageInto</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    main<span class="token punctuation">.</span>textContent <span class="token operator">=</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>另外，<code>import()</code>函数与所加载的模块没有静态连接关系，这点也是与<code>import</code>语句不相同。<code>import()</code>加载模块成功以后，这个模块会作为一个对象，当作<code>then</code>方法的参数。</p> <p>如果想同时加载多个模块，可以采用下面的写法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module1.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module2.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module3.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>module1<span class="token punctuation">,</span> module2<span class="token punctuation">,</span> module3<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   ···
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者用在 async 函数之中</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> myModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./myModule.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>export1<span class="token punctuation">,</span> export2<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./myModule.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>module1<span class="token punctuation">,</span> module2<span class="token punctuation">,</span> module3<span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module1.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module2.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module3.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li>https://nodejs.org/dist/latest-v12.x/docs/api/modules.html</li> <li>https://www.cnblogs.com/myfirstboke/p/10563597.html</li> <li>http://es6.ruanyifeng.com/#docs/module-loader</li> <li>https://www.jianshu.com/p/ad427d8879cb</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/falost/nodejs-blockchain/edit/master/book/chapter/01/03-DDN区块链模块规范解读.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/20/2020, 7:08:50 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nodejs-blockchain/chapter/01/02-DDN区块链加密库的选择.html" class="prev">第2节 DDN区块链加密库的选择</a></span> <span class="next"><a href="/nodejs-blockchain/chapter/02/01-planning.html">第2章 开发实践</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/nodejs-blockchain/assets/js/app.9b1d5e7c.js" defer></script><script src="/nodejs-blockchain/assets/js/2.5839780c.js" defer></script><script src="/nodejs-blockchain/assets/js/10.a5621495.js" defer></script>
  </body>
</html>
